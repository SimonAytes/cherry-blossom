<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Simon Aytes">

<title>Cherry Blossom Predictions 2024</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="Cherry-Blossom_files/libs/clipboard/clipboard.min.js"></script>
<script src="Cherry-Blossom_files/libs/quarto-html/quarto.js"></script>
<script src="Cherry-Blossom_files/libs/quarto-html/popper.min.js"></script>
<script src="Cherry-Blossom_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Cherry-Blossom_files/libs/quarto-html/anchor.min.js"></script>
<link href="Cherry-Blossom_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Cherry-Blossom_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Cherry-Blossom_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Cherry-Blossom_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Cherry-Blossom_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#data-preprocessing" id="toc-data-preprocessing" class="nav-link" data-scroll-target="#data-preprocessing"><span class="header-section-number">2</span> Data Preprocessing</a></li>
  <li><a href="#representative-locations" id="toc-representative-locations" class="nav-link" data-scroll-target="#representative-locations"><span class="header-section-number">3</span> Representative Locations</a></li>
  <li><a href="#historical-weather-data" id="toc-historical-weather-data" class="nav-link" data-scroll-target="#historical-weather-data"><span class="header-section-number">4</span> Historical Weather Data</a></li>
  <li><a href="#creating-the-training-dataset" id="toc-creating-the-training-dataset" class="nav-link" data-scroll-target="#creating-the-training-dataset"><span class="header-section-number">5</span> Creating the Training Dataset</a></li>
  <li><a href="#constructing-the-model" id="toc-constructing-the-model" class="nav-link" data-scroll-target="#constructing-the-model"><span class="header-section-number">6</span> Constructing the Model</a></li>
  <li><a href="#final-model-predictions" id="toc-final-model-predictions" class="nav-link" data-scroll-target="#final-model-predictions"><span class="header-section-number">7</span> Final Model Predictions</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Cherry Blossom Predictions 2024</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Simon Aytes </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Cherry-Blossom_files/figure-html/065d663b-63e6-4b98-ad2b-7cb28e7a0762-1-1839357a-a700-457f-9a24-0f260ad7bfeb.jpg" class="img-fluid figure-img"></p>
<figcaption>Photo by AJ on Unsplash.jpg</figcaption>
</figure>
</div>
<div id="79f2db86-b83f-4a08-917e-e42cb54b2aa4" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src <span class="im">import</span> cherry_blossom_utils <span class="im">as</span> util</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src <span class="im">import</span> prediction_utils <span class="im">as</span> pred_util</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime <span class="im">as</span> dt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>With cherry blossom trees blooming earlier than ever in the past decade due to climate change, forecasting their peak bloom remains a formidable challenge. The National Parks Service underscores the difficulty of this task, stating that predicting peak bloom is nearly impossible more than 10 days in advance due to the trees’ sensitivity to weather conditions.</p>
<p>Given this inherent challenge, our team set our sights on creating a model that allows us to predict peak bloom in as little as two months in advance. For this task, we utilized over 245 unique features of the previous year’s weather data to predict peak bloom. We successfully trained a Gradient Boosting Regressor (GBR) model which allows us to predict the peak bloom date for any location using only the previous year’s weather data.</p>
<p>Our model was then used to predict the peak bloom dates for: NYC (USA), Washington, D.C., Vancouver (Canada), Kyoto (Japan), and Liestal-Weideli (Switzerland).</p>
</section>
<section id="data-preprocessing" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Data Preprocessing</h1>
<p>The data provided by the event organizers will form the foundation of our training dataset. Some files – like Switzerland and Japan – are already in our ideal format. However, the USA-NPN dataset needs some additional formatting before it is usable.</p>
<div id="2d680db0-67dd-43b9-b1c1-6e9df46f342e" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load USA-NPN dataset</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>usa_npn <span class="op">=</span> pd.read_csv(<span class="st">"./data/raw/USA-NPN_status_intensity_observations_data.csv"</span>, na_values<span class="op">=</span>[<span class="op">-</span><span class="fl">9999.00</span>])</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get NYC-specific data</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>nyc_df <span class="op">=</span> usa_npn[(usa_npn[<span class="st">'Site_ID'</span>] <span class="op">==</span> <span class="dv">32789</span>) <span class="op">&amp;</span> (usa_npn[<span class="st">'Species_ID'</span>] <span class="op">==</span> <span class="dv">228</span>)]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>nyc_df <span class="op">=</span> nyc_df[[<span class="st">'Species_ID'</span>, <span class="st">'Site_ID'</span>, <span class="st">'Latitude'</span>, <span class="st">'Longitude'</span>, <span class="st">'Elevation_in_Meters'</span>, <span class="st">'Observation_Date'</span>, <span class="st">'Day_of_Year'</span>, <span class="st">'Phenophase_Status'</span>]]</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>nyc_bloom_df <span class="op">=</span> util.format_df(nyc_df)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>nyc_bloom_df <span class="op">=</span> nyc_bloom_df[[<span class="st">'location'</span>, <span class="st">'Latitude'</span>, <span class="st">'Longitude'</span>, <span class="st">'Elevation_in_Meters'</span>, <span class="st">'Year'</span>, <span class="st">'Observation_Date'</span>, <span class="st">'Day_of_Year'</span>]]</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>nyc_bloom_df.columns <span class="op">=</span> [<span class="st">'location'</span>, <span class="st">'lat'</span>, <span class="st">'long'</span>, <span class="st">'alt'</span>, <span class="st">'year'</span>, <span class="st">'bloom_date'</span>, <span class="st">'bloom_doy'</span>]</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the dataframe to CSV</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>nyc_bloom_df.to_csv(<span class="st">"./data/interim/main_locations/validation/nyc.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Get USA data</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>usa_df <span class="op">=</span> usa_npn[(usa_npn[<span class="st">'Site_ID'</span>] <span class="op">!=</span> <span class="dv">32789</span>) <span class="op">|</span> (usa_npn[<span class="st">'Species_ID'</span>] <span class="op">!=</span> <span class="dv">228</span>)]</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>usa_df <span class="op">=</span> usa_df[[<span class="st">'Species_ID'</span>, <span class="st">'Site_ID'</span>, <span class="st">'Latitude'</span>, <span class="st">'Longitude'</span>, <span class="st">'Elevation_in_Meters'</span>, <span class="st">'Observation_Date'</span>, <span class="st">'Day_of_Year'</span>, <span class="st">'Phenophase_Status'</span>]]</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>usa_bloom_df <span class="op">=</span> util.format_df(usa_df)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>usa_bloom_df <span class="op">=</span> usa_bloom_df[[<span class="st">'location'</span>, <span class="st">'Latitude'</span>, <span class="st">'Longitude'</span>, <span class="st">'Elevation_in_Meters'</span>, <span class="st">'Year'</span>, <span class="st">'Observation_Date'</span>, <span class="st">'Day_of_Year'</span>]]</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>usa_bloom_df.columns <span class="op">=</span> [<span class="st">'location'</span>, <span class="st">'lat'</span>, <span class="st">'long'</span>, <span class="st">'alt'</span>, <span class="st">'year'</span>, <span class="st">'bloom_date'</span>, <span class="st">'bloom_doy'</span>]</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the dataframe to CSV</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>usa_bloom_df.to_csv(<span class="st">"./data/raw/usa_formatted.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In addition to the re-formatting of this file, we also need to isolate the data for NYC which is one of the locations included in the contest submission. Therefore, two dataframes will be created; one for NYC and another for all other locations in the US.</p>
<p>After processing these files, we are left with the following two dataframes:</p>
<p><strong>USA Dataframe</strong></p>
<div id="939c0515-9e15-416a-a0b4-032b21d44ee4" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>usa_bloom_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>
<div><div id="f990e928-c3dd-4e29-9574-3dbeb82ed3ee" style="display:none; background-color:#9D6CFF; color:white; width:200px; height:30px; padding-left:5px; border-radius:4px; flex-direction:row; justify-content:space-around; align-items:center;" onmouseover="this.style.backgroundColor='#BA9BF8'" onmouseout="this.style.backgroundColor='#9D6CFF'" onclick="window.commands?.execute('create-mitosheet-from-dataframe-output');">See Full Dataframe in Mito</div> <script> if (window.commands?.hasCommand('create-mitosheet-from-dataframe-output')) document.getElementById('f990e928-c3dd-4e29-9574-3dbeb82ed3ee').style.display = 'flex' </script> 
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">location</th>
<th data-quarto-table-cell-role="th">lat</th>
<th data-quarto-table-cell-role="th">long</th>
<th data-quarto-table-cell-role="th">alt</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">bloom_date</th>
<th data-quarto-table-cell-role="th">bloom_doy</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2251</td>
<td>45.485600</td>
<td>-122.855499</td>
<td>63</td>
<td>2010</td>
<td>2010-02-27</td>
<td>58</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1841</td>
<td>39.973316</td>
<td>-82.802826</td>
<td>275</td>
<td>2010</td>
<td>2010-04-04</td>
<td>94</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>8861</td>
<td>41.713570</td>
<td>-121.507545</td>
<td>1452</td>
<td>2013</td>
<td>2013-05-08</td>
<td>128</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>8861</td>
<td>41.713570</td>
<td>-121.507545</td>
<td>1452</td>
<td>2014</td>
<td>2014-05-01</td>
<td>121</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>8861</td>
<td>41.713570</td>
<td>-121.507545</td>
<td>1452</td>
<td>2015</td>
<td>2015-05-20</td>
<td>140</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<p><strong>NYC Dataframe</strong></p>
<div id="1e1e5e3f-e10d-4453-ba5c-2d871dcb6e44" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>nyc_bloom_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>
<div><div id="fc5d0081-a409-4f2a-8776-e2e0dae54612" style="display:none; background-color:#9D6CFF; color:white; width:200px; height:30px; padding-left:5px; border-radius:4px; flex-direction:row; justify-content:space-around; align-items:center;" onmouseover="this.style.backgroundColor='#BA9BF8'" onmouseout="this.style.backgroundColor='#9D6CFF'" onclick="window.commands?.execute('create-mitosheet-from-dataframe-output');">See Full Dataframe in Mito</div> <script> if (window.commands?.hasCommand('create-mitosheet-from-dataframe-output')) document.getElementById('fc5d0081-a409-4f2a-8776-e2e0dae54612').style.display = 'flex' </script> 
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">location</th>
<th data-quarto-table-cell-role="th">lat</th>
<th data-quarto-table-cell-role="th">long</th>
<th data-quarto-table-cell-role="th">alt</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">bloom_date</th>
<th data-quarto-table-cell-role="th">bloom_doy</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>32789</td>
<td>40.73082</td>
<td>-73.99733</td>
<td>5</td>
<td>2019</td>
<td>2019-04-08</td>
<td>98</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>32789</td>
<td>40.73082</td>
<td>-73.99733</td>
<td>5</td>
<td>2021</td>
<td>2021-04-05</td>
<td>95</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>32789</td>
<td>40.73082</td>
<td>-73.99733</td>
<td>5</td>
<td>2022</td>
<td>2022-03-30</td>
<td>89</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>32789</td>
<td>40.73082</td>
<td>-73.99733</td>
<td>5</td>
<td>2023</td>
<td>2023-04-02</td>
<td>92</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<p>With the data sucessfully prepared and formatted, we can begin analyzing the data and preparing it for the model.</p>
</section>
<section id="representative-locations" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Representative Locations</h1>
<p>Amongst the supplied datasets, there were data for numerous locations from all across Asia, Europe, and North America. While it would be ideal to have extensive background data from all locations, given the time constraints of this competition we will instead take a different approach. In order to emulate the geographical diversity of the dataset in as few locations as possible, we will identify so-called “Representative Locations” for which we will acquire extensive historical data.</p>
<p>The Representative Locations are selected using a KMeans clustering algorithm, which clusters all available locations based on their latitude and longitude. Once clustered, we designate the location with the most number of observations as that cluster’s Representative Location. From this, we are able to preserve the geographical diversity of the dataset in as few locations as possible.</p>
<p>For consistency’s sake, we keep a constant k-value of <code>k=5</code>, giving us five Representative Locations for each dataset. We do this to ensure that no one-place is overrepresented in the supplemental data, as the norm would be to dynamically calculate the k-value based on the elbow-curve method.</p>
<div id="36cb43e8-74a6-4bfa-9dde-f4381d8998f9" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For each file, find its representative locations</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> location <span class="kw">in</span> util.location_dict:</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    clusters, rep_locations, loc_data <span class="op">=</span> util.get_representative_locations(util.location_dict[location], location)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Output the cluster data</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    clusters.to_csv(<span class="ss">f"</span><span class="sc">{</span>util<span class="sc">.</span>CLUSTERS_FOLDER<span class="sc">}{</span>location<span class="sc">}</span><span class="ss">_clusters.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Output the representative location lists</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    rep_locations.to_csv(<span class="ss">f"</span><span class="sc">{</span>util<span class="sc">.</span>LOCATIONS_FOLDER<span class="sc">}{</span>location<span class="sc">}</span><span class="ss">_representative_locations.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ouput location-specific validation data</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(loc_data)):</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        loc_data[i].to_csv(<span class="ss">f"</span><span class="sc">{</span>util<span class="sc">.</span>VALIDATION_FOLDER<span class="sc">}{</span>location<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Plotting these representative locations on the map below, we can see that they are adequately spread out across the areas of interest.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Cherry-Blossom_files/figure-html/39391db7-f08f-4bcf-a330-fe4cc6fada2f-1-5a3b60c9-64c2-49c9-aee4-9bd2e541bfd2.png" class="img-fluid figure-img"></p>
<figcaption>RepresentativeLocations.png</figcaption>
</figure>
</div>
</section>
<section id="historical-weather-data" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Historical Weather Data</h1>
<p>Disparate sources for historical weather data cause a lot of issues when trying to create a cohesive dataset for multiple locations across multiple jurisdictions. Our search for a single data source brought us to <a href="https://www.visualcrossing.com/">Visual Crossing</a> – a weather data and analytics firm – whose data spans the world-over and has ample coverage for our use-case.</p>
<p>In total, we gathered data for the above-mentioned Representative Locations, as well as the five locations included in the final prediction (NYC, Washington DC, Vancouver, Kyoto, and Liestal).</p>
<p><strong>Data Features</strong></p>
<p>When exploring the data offered by Visual Crossing, we identified the following candidate features as features for our training dataset along with the associated reasons:</p>
<ul>
<li><strong>Maximum temperature, Minimum temperature, Temperature:</strong> Temperature plays a significant role in the blooming process of cherry blossoms. Both minimum and maximum temperatures can influence the timing of bloom.</li>
<li><strong>Dew:</strong> Dew can impact the moisture levels around the cherry blossom trees, which could affect their blooming.</li>
<li><strong>Humidity:</strong> Humidity levels can also influence the health and growth of cherry blossoms.</li>
<li><strong>Precipitation amount, Precipitation probability, Precipitation type, Precipitation cover:</strong> Precipitation can affect soil moisture and overall environmental conditions for cherry blossoms.</li>
<li><strong>Wind speed, Wind direction, Wind gust:</strong> Wind conditions can impact the dispersal of pollen and affect the health of cherry blossoms.</li>
<li><strong>Pressure:</strong> Atmospheric pressure can influence weather patterns, which in turn can affect cherry blossom growth.</li>
<li><strong>Cloud cover:</strong> Cloud cover affects the amount of sunlight reaching the cherry blossom trees, which can influence their growth and blooming.</li>
<li><strong>Solar radiation, Solar energy, UV index:</strong> These variables are directly related to the cherry blossom tree’s exposure to sunlight, which is essential for photosynthesis and their overall health.</li>
</ul>
<p><strong>Timespan</strong></p>
<p>Some locations, like Kyoto, have extensive historical records while others, like NYC, only have data going back a few years. For this reason, we decided to focus our efforts on collecting as much weather data as possible for the past 20-30 years for each location. As such, our timeframe for these data queries were either <code>1990-01-01</code> to <code>2023-12-31</code> <strong>OR</strong> <code>2000-01-01</code> to <code>2023-12-31</code>, depending on the availability of the target features.</p>
<p>This method ensured that we would not run the risk of having less weather data than prediction data, ultimately allowing us to make the best use of the competition datasets.</p>
<div id="8fa9d1db-b402-420c-a0bf-babccff90918" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(util.dir_paths)):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process the raw data</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    df_dict <span class="op">=</span> util.process_weather_files(util.dir_paths[index])</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Output the aggregated files</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> file_name <span class="kw">in</span> df_dict:</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        df_dict[file_name].to_csv(<span class="ss">f"</span><span class="sc">{</span>util<span class="sc">.</span>OUTPUT_PATHS[index]<span class="sc">}{</span>file_name<span class="sc">}</span><span class="ss">"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>Data Aggregation</strong></p>
<p>The weather data pulled from Visual Crossing was in daily format, so we had to aggregate the data to get it in the desired format of monthly averages. This process was straightforward and yielded the following results.</p>
<p>It is important to note that the integers next to the variable names represent months (i.e.&nbsp;_01 is January, _02 is February, etc.).</p>
<div id="064e587c-0e3b-4961-9949-08d4f122dbfd" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df_dict[file_name].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>
<div><div id="418d2ebc-414a-4976-931c-e57a3017e88d" style="display:none; background-color:#9D6CFF; color:white; width:200px; height:30px; padding-left:5px; border-radius:4px; flex-direction:row; justify-content:space-around; align-items:center;" onmouseover="this.style.backgroundColor='#BA9BF8'" onmouseout="this.style.backgroundColor='#9D6CFF'" onclick="window.commands?.execute('create-mitosheet-from-dataframe-output');">See Full Dataframe in Mito</div> <script> if (window.commands?.hasCommand('create-mitosheet-from-dataframe-output')) document.getElementById('418d2ebc-414a-4976-931c-e57a3017e88d').style.display = 'flex' </script> 
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">location</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">tempmax_01</th>
<th data-quarto-table-cell-role="th">tempmax_02</th>
<th data-quarto-table-cell-role="th">tempmax_03</th>
<th data-quarto-table-cell-role="th">tempmax_04</th>
<th data-quarto-table-cell-role="th">tempmax_05</th>
<th data-quarto-table-cell-role="th">tempmax_06</th>
<th data-quarto-table-cell-role="th">tempmax_07</th>
<th data-quarto-table-cell-role="th">tempmax_08</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">day_length_03</th>
<th data-quarto-table-cell-role="th">day_length_04</th>
<th data-quarto-table-cell-role="th">day_length_05</th>
<th data-quarto-table-cell-role="th">day_length_06</th>
<th data-quarto-table-cell-role="th">day_length_07</th>
<th data-quarto-table-cell-role="th">day_length_08</th>
<th data-quarto-table-cell-role="th">day_length_09</th>
<th data-quarto-table-cell-role="th">day_length_10</th>
<th data-quarto-table-cell-role="th">day_length_11</th>
<th data-quarto-table-cell-role="th">day_length_12</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>38.8853,-77.0386</td>
<td>1990</td>
<td>10.967742</td>
<td>12.432143</td>
<td>15.245161</td>
<td>19.246667</td>
<td>22.383871</td>
<td>28.860000</td>
<td>30.751613</td>
<td>28.596774</td>
<td>...</td>
<td>43078.612903</td>
<td>47639.000000</td>
<td>51494.967742</td>
<td>53448.133333</td>
<td>52488.193548</td>
<td>49126.870968</td>
<td>44772.666667</td>
<td>40234.258065</td>
<td>36247.633333</td>
<td>34173.451613</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>38.8853,-77.0386</td>
<td>1991</td>
<td>7.567742</td>
<td>10.939286</td>
<td>13.719355</td>
<td>19.566667</td>
<td>27.732258</td>
<td>29.806667</td>
<td>31.935484</td>
<td>31.222581</td>
<td>...</td>
<td>43041.838710</td>
<td>47604.233333</td>
<td>51469.806452</td>
<td>53443.166667</td>
<td>52506.096774</td>
<td>49158.258065</td>
<td>44808.600000</td>
<td>40269.387097</td>
<td>36274.366667</td>
<td>34178.580645</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>38.8853,-77.0386</td>
<td>1992</td>
<td>7.612903</td>
<td>9.441379</td>
<td>11.632258</td>
<td>17.906667</td>
<td>21.729032</td>
<td>26.723333</td>
<td>30.354839</td>
<td>27.400000</td>
<td>...</td>
<td>43157.258065</td>
<td>47712.500000</td>
<td>51547.354839</td>
<td>53456.033333</td>
<td>52447.258065</td>
<td>49057.806452</td>
<td>44695.266667</td>
<td>40159.612903</td>
<td>36192.466667</td>
<td>34164.838710</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>38.8853,-77.0386</td>
<td>1993</td>
<td>7.838710</td>
<td>5.507143</td>
<td>9.519355</td>
<td>17.830000</td>
<td>24.764516</td>
<td>29.040000</td>
<td>33.035484</td>
<td>31.106452</td>
<td>...</td>
<td>43120.290323</td>
<td>47677.833333</td>
<td>51522.258065</td>
<td>53451.500000</td>
<td>52465.612903</td>
<td>49089.548387</td>
<td>44731.466667</td>
<td>40195.161290</td>
<td>36219.066667</td>
<td>34169.645161</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>38.8853,-77.0386</td>
<td>1994</td>
<td>1.948387</td>
<td>6.750000</td>
<td>12.145161</td>
<td>22.250000</td>
<td>22.790323</td>
<td>31.390000</td>
<td>31.967742</td>
<td>28.403226</td>
<td>...</td>
<td>43083.548387</td>
<td>47642.833333</td>
<td>51497.129032</td>
<td>53446.733333</td>
<td>52483.967742</td>
<td>49121.451613</td>
<td>44767.700000</td>
<td>40230.290323</td>
<td>36245.866667</td>
<td>34174.645161</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</section>
<section id="creating-the-training-dataset" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Creating the Training Dataset</h1>
<p>After standardizing the format of all our raw data files, we then created a single dataset with all available training examples. During this process, locations whose observations did not occur in the past 30-years were dropped. This occurred in a few cities where the most-recent observations for <code>bloom_doy</code> were from the mid-20th century.</p>
<p>The final dataset contains 267 observations from 21 different locations across the globe.</p>
<p><strong>Missing Values</strong></p>
<p>To address gaps in the data we employed the use of dataset-means to fill in missing values. This allowed us to have a more complete dataset.</p>
<p><strong>Outliers</strong></p>
<p>Our tests indicated that the removal of outliers hurt our model (R2 decreased by ~0.3). As such, we opted to leave them in in favor of a more diverse training dataset.</p>
<div id="4a405dd6-5a02-4d47-a569-702052f4ae08" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>combined_df <span class="op">=</span> pd.DataFrame()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(util.VALIDATION_PATHS)):</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process the raw data</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    df_dict <span class="op">=</span> util.combine_files(util.VALIDATION_PATHS[index], util.CLEANED_PATHS[index])</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Output the aggregated files</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> file_name <span class="kw">in</span> df_dict:</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        df_dict[file_name].to_csv(<span class="ss">f"</span><span class="sc">{</span>util<span class="sc">.</span>INDIV_OUT_PATH<span class="sc">}{</span>file_name<span class="sc">}</span><span class="ss">"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        combined_df <span class="op">=</span> pd.concat([combined_df, df_dict[file_name]], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>combined_df <span class="op">=</span> combined_df.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># To handle missing values, use the mean of each feature</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>combined_df <span class="op">=</span> combined_df.fillna(combined_df.mean(numeric_only<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>combined_df.to_csv(<span class="ss">f"</span><span class="sc">{</span>util<span class="sc">.</span>COMBINED_OUT_PATH<span class="sc">}</span><span class="ss">combined.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>Training Dataset</strong></p>
<p>A random sample of five observations is shown below to demonstrate the format of the training dataset. The columns <code>location</code> and <code>year</code> are purely descriptive and are omitted when training the model. <code>bloom_doy</code> is the value we are predicting.</p>
<div id="4579dfe2-790d-4913-a094-e5656c2331ee" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>combined_df.sample(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>
<div><div id="6367ae76-ca2a-4560-9528-cf8c30a7f7f9" style="display:none; background-color:#9D6CFF; color:white; width:200px; height:30px; padding-left:5px; border-radius:4px; flex-direction:row; justify-content:space-around; align-items:center;" onmouseover="this.style.backgroundColor='#BA9BF8'" onmouseout="this.style.backgroundColor='#9D6CFF'" onclick="window.commands?.execute('create-mitosheet-from-dataframe-output');">See Full Dataframe in Mito</div> <script> if (window.commands?.hasCommand('create-mitosheet-from-dataframe-output')) document.getElementById('6367ae76-ca2a-4560-9528-cf8c30a7f7f9').style.display = 'flex' </script> 
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">location</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">bloom_doy</th>
<th data-quarto-table-cell-role="th">lat</th>
<th data-quarto-table-cell-role="th">long</th>
<th data-quarto-table-cell-role="th">bloom_date</th>
<th data-quarto-table-cell-role="th">alt</th>
<th data-quarto-table-cell-role="th">tempmax_01</th>
<th data-quarto-table-cell-role="th">tempmax_02</th>
<th data-quarto-table-cell-role="th">tempmax_03</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">day_length_03</th>
<th data-quarto-table-cell-role="th">day_length_04</th>
<th data-quarto-table-cell-role="th">day_length_05</th>
<th data-quarto-table-cell-role="th">day_length_06</th>
<th data-quarto-table-cell-role="th">day_length_07</th>
<th data-quarto-table-cell-role="th">day_length_08</th>
<th data-quarto-table-cell-role="th">day_length_09</th>
<th data-quarto-table-cell-role="th">day_length_10</th>
<th data-quarto-table-cell-role="th">day_length_11</th>
<th data-quarto-table-cell-role="th">day_length_12</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">165</td>
<td>liestal</td>
<td>1994</td>
<td>82</td>
<td>47.481400</td>
<td>7.730519</td>
<td>1994-03-23</td>
<td>350.00</td>
<td>7.390323</td>
<td>4.314286</td>
<td>10.906452</td>
<td>...</td>
<td>42940.000000</td>
<td>49129.833333</td>
<td>54461.096774</td>
<td>57227.833333</td>
<td>55852.483871</td>
<td>51155.838710</td>
<td>45217.666667</td>
<td>39066.161290</td>
<td>33585.400000</td>
<td>30670.774194</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">96</td>
<td>South Korea/Yeosu</td>
<td>2018</td>
<td>91</td>
<td>34.739290</td>
<td>127.740640</td>
<td>2018-04-01</td>
<td>64.64</td>
<td>6.425806</td>
<td>8.789286</td>
<td>13.648387</td>
<td>...</td>
<td>43102.129032</td>
<td>47241.333333</td>
<td>50731.451613</td>
<td>52496.166667</td>
<td>51642.645161</td>
<td>48616.000000</td>
<td>44672.100000</td>
<td>40554.290323</td>
<td>36945.066667</td>
<td>35067.225806</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">112</td>
<td>South Korea/Suwon</td>
<td>2020</td>
<td>96</td>
<td>37.272260</td>
<td>126.985330</td>
<td>2020-04-05</td>
<td>34.84</td>
<td>4.829032</td>
<td>6.435714</td>
<td>12.667742</td>
<td>...</td>
<td>43008.354839</td>
<td>47383.533333</td>
<td>51094.903226</td>
<td>53005.933333</td>
<td>52143.516129</td>
<td>48963.774194</td>
<td>44804.933333</td>
<td>40455.419355</td>
<td>36621.333333</td>
<td>34589.548387</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">81</td>
<td>Switzerland/Vira / Gambarogno</td>
<td>2016</td>
<td>98</td>
<td>46.143428</td>
<td>8.841697</td>
<td>2016-04-07</td>
<td>210.00</td>
<td>-0.751613</td>
<td>-0.542857</td>
<td>4.635484</td>
<td>...</td>
<td>42885.161290</td>
<td>48916.333333</td>
<td>54113.129032</td>
<td>56830.766667</td>
<td>55542.387097</td>
<td>51008.806452</td>
<td>45238.000000</td>
<td>39247.096774</td>
<td>33904.600000</td>
<td>31037.258065</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">226</td>
<td>kyoto</td>
<td>2022</td>
<td>91</td>
<td>35.011983</td>
<td>135.676114</td>
<td>2022-04-01</td>
<td>44.00</td>
<td>9.093548</td>
<td>12.164286</td>
<td>16.725806</td>
<td>...</td>
<td>43121.838710</td>
<td>47079.966667</td>
<td>50412.548387</td>
<td>52093.600000</td>
<td>51279.483871</td>
<td>48390.677419</td>
<td>44620.466667</td>
<td>40682.774194</td>
<td>37235.700000</td>
<td>35446.354839</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</section>
<section id="constructing-the-model" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Constructing the Model</h1>
<p>We initially reviewed four candidate models for this prediction task: SVR, Linear Regression, Random Forest Regression, and Gradient Boost Regression.</p>
<p>Following an analysis of each model’s performance, it was decided that we would use a <strong>Gradient Boost Regression (GBR)</strong> model.</p>
<p>With the candidate model selected, we then moved on to the final two tasks before deploying the model and making our final predictions: feature extraction and HPO.</p>
<p><strong>Feature Extraction</strong></p>
<p>We used Cumulative Feature Importance with a threshold of <code>0.90</code> to conduct our feature extraction. This process narrowed our feature space from 240+ features down to the 34 most-important features.</p>
<p>The figure below shows the relative feature importance of the selected features, as well as a cumulative feature importance graph showing their additive importance.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Cherry-Blossom_files/figure-html/1589f93d-e6f8-49ce-bdb6-e3f74d103df2-1-9425a680-f859-4575-ab28-ad80fa8f6621.png" class="img-fluid figure-img"></p>
<figcaption>Feature_Selection.png</figcaption>
</figure>
</div>
<p><strong>Hyper Parameter Optimization (HPO)</strong></p>
<p>We used the <code>scikit-learn::GridSearchCV</code> to perform our HPO. Our initial configuration space had approximately 18,000 unique combinations and each iteration was evaluated based on its R2 value.</p>
<p>The table below shows our selected hyper-parameter values following this analysis.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Cherry-Blossom_files/figure-html/a3e9a0d7-6e53-4619-810c-cd76e5ea5a01-1-ed87dea0-b635-4398-8722-0cf37add9923.png" class="img-fluid figure-img"></p>
<figcaption>ConfigurationSpace.png</figcaption>
</figure>
</div>
<p><strong>Model Performance</strong></p>
<p>After identifying the ideal hyper-parameters and features, we created an optimal version of the GBR model.</p>
<p>This model produced the following MSE and R2 values:</p>
<div id="4abb413e-64fe-4d3a-aa64-6a49f82cc61b" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load combined data</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(<span class="st">"./data/cleaned/combined.csv"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove metadata columns</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data.drop(columns<span class="op">=</span>[<span class="st">'location'</span>, <span class="st">'lat'</span>, <span class="st">'long'</span>, <span class="st">'alt'</span>, <span class="st">'year'</span>, <span class="st">'bloom_date'</span>])</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Split features (X) and target variable (y)</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> data.drop(columns<span class="op">=</span>[<span class="st">'bloom_doy'</span>])</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> data[<span class="st">'bloom_doy'</span>]</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Split the data into training and testing sets</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> pred_util.train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset the data based on the selected features</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>X_train_scaled <span class="op">=</span> pred_util.scaler.fit_transform(X_train[pred_util.selected_features])</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>X_test_scaled <span class="op">=</span> pred_util.scaler.transform(X_test[pred_util.selected_features])</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Capture scaling parameters using the X_train dataframe</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset it by taking the selected_features</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>normalization_params <span class="op">=</span> pred_util.compute_normalization_params(X_train[pred_util.selected_features])</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize and train the Gradient Boosting Regressor</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> pred_util.GradientBoostingRegressor(<span class="op">**</span>pred_util.best_params)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled, y_train)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Make predictions and cast from float to integer</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>y_pred_int <span class="op">=</span> pred_util.get_predictions(X_test_scaled, model)</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Model evaluation (MSE and R2)</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>pred_util.evaluate_model(y_test, y_pred_int) <span class="co"># THIS PRINTS MSE and R2</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: THIS MODEL HAS ALREADY BEEN CREATED AND SAVED, SO THAT PART OF THE CODE HAS BEEN</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="co">#       LEFT OUT. IF YOU ARE INTERESTED IN SEEING THAT PORTION OF THE CODE,</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="co">#       PLEASE LOOK THROUGH "./notebooks/4-ConstructModel.ipynb".</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mean Squared Error: 59.074074074074076
R-squared: 0.8707358436763668</code></pre>
</div>
</div>
</section>
<section id="final-model-predictions" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Final Model Predictions</h1>
<p>Finally, our model was deployed and used to predict the <code>bloom_doy</code> for the final five locations: NYC, Washington DC, Vancouver, Kyoto, and Liestal.</p>
<p>The final predictions (with intervals) are as follows:</p>
<div id="1bc30a10-ee92-45f7-a446-ffcc4c427e87" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load new data here</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>file_path <span class="op">=</span> <span class="st">"./data/inputs/competition_input.csv"</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>input_df <span class="op">=</span> pd.read_csv(file_path)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>input_df <span class="op">=</span> input_df[pred_util.feature_list]</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize data</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>input_df <span class="op">=</span> pred_util.normalize_new_data(input_df, pred_util.normalization_params)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>predictions, lower_bound, upper_bound <span class="op">=</span> pred_util.get_final_predictions(input_df, pred_util.model)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>predictions_df <span class="op">=</span> pd.read_csv(file_path)[[<span class="st">'location'</span>]]</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>predictions_df[<span class="st">"prediction"</span>] <span class="op">=</span> predictions</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>predictions_df[<span class="st">"lower"</span>] <span class="op">=</span> lower_bound</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>predictions_df[<span class="st">"upper"</span>] <span class="op">=</span> upper_bound</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>predictions_df <span class="op">=</span> predictions_df[[<span class="st">'location'</span>, <span class="st">'prediction'</span>, <span class="st">'lower'</span>, <span class="st">'upper'</span>]]</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an output filename using the current timestamp</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>output_file_name <span class="op">=</span> <span class="ss">f"./data/output/</span><span class="sc">{</span>dt<span class="sc">.</span>now()<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">_%H-%M-%S'</span>) <span class="op">+</span> <span class="st">'.csv'</span><span class="sc">}</span><span class="ss">"</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the dataframe</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>predictions_df.to_csv(output_file_name, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>predictions_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>
<div><div id="25b82a40-ce42-4820-ab8f-1b917c988aa0" style="display:none; background-color:#9D6CFF; color:white; width:200px; height:30px; padding-left:5px; border-radius:4px; flex-direction:row; justify-content:space-around; align-items:center;" onmouseover="this.style.backgroundColor='#BA9BF8'" onmouseout="this.style.backgroundColor='#9D6CFF'" onclick="window.commands?.execute('create-mitosheet-from-dataframe-output');">See Full Dataframe in Mito</div> <script> if (window.commands?.hasCommand('create-mitosheet-from-dataframe-output')) document.getElementById('25b82a40-ce42-4820-ab8f-1b917c988aa0').style.display = 'flex' </script> 
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">location</th>
<th data-quarto-table-cell-role="th">prediction</th>
<th data-quarto-table-cell-role="th">lower</th>
<th data-quarto-table-cell-role="th">upper</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>washingtondc</td>
<td>81</td>
<td>80</td>
<td>83</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>liestal</td>
<td>84</td>
<td>83</td>
<td>86</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>kyoto</td>
<td>95</td>
<td>93</td>
<td>97</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>vancouver</td>
<td>94</td>
<td>92</td>
<td>96</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>nyc</td>
<td>88</td>
<td>86</td>
<td>89</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>